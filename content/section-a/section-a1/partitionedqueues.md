+++
title = "Partitions and In-Order processing"
description = "Partitions and In-Order processing"
weight = 1
+++

## Content

This reference app helps you ensure in-order processing using partitioned queues.

### Basic Concepts


The messages on RabbitMQ are typically processed in order of arrival using the FIFO convention. There are scenarios where in-order processing of messages based on their specific data-element e.g. group-id, or Order number, or Case number is required. It's a challenge when you have multiple consumers listening on the same queue. The competing consumers can process messages in parallel thus impacting strict ordering of specific group of messages. Those cases can be handled by partitioning the queues where each partition always receives the messages with same id, or order number or case number. 


#### Implementing Producer:

This app sets order-number as partitionKey in the message headers before sending the message to partitioned RabbitMQ queue. The additional info is specified in the application properties as listed below. This ensures that an order-number will always go to its specific partition only which is generated by the hashkey of the partitionKey.

![](/images/rabbitmq/referenceapps/03Producer.png "Producer")


#### Producer Properties

The properties specify three partitions to be created and also specify where to find the partition-key-expression in the message. RabbitMQ will use this hashcode of this value and publish this message to one of the partitions. This ensures that whenever this same headerKey appears, it will always go to the same partition.


![](/images/rabbitmq/referenceapps/03PropertiesP.png "Producer properties")


#### Implementing Consumer

The consumer code itself is simple however we will be running three instances of the consumers to listen to messages in three partitions. The properties of each of three instances will specify which partition each consumer is listening in.

To run three consumerPartitions, run these commands in three different consoles:

java -jar target/consumePartition-0.0.3-SNAPSHOT.jar --spring.config.import=file:./partition1.yml

java -jar target/consumePartition-0.0.3-SNAPSHOT.jar --spring.config.import=file:./partition2.yml

java -jar target/consumePartition-0.0.3-SNAPSHOT.jar --spring.config.import=file:./partition3.yml

![](/images/rabbitmq/referenceapps/03Consumer.png "Consumer")


#### Consumer properties

The property partitioned=true specifies the consumer that the queue is partitioned and the instanceCount specifies the number of partitions.

The first consumer will have instanceIndex as 0:

![](/images/rabbitmq/referenceapps/03PropertiesC1.png "Consumer")

The second consumer will have instanceIndex as 1:

![](/images/rabbitmq/referenceapps/03PropertiesC2.png "Consumer")

The third consumer will have instanceIndex as 2:

![](/images/rabbitmq/referenceapps/03PropertiesC3.png "Consumer")

Send the following messages to producer to kick off the process, notice the orderNumber e.g. 1003 gets processed by the same consumer instance every time:

    http://localhost:9090/orders/publish

    {
        "orderNumber": 1003,
        "quantity": 5,
        "productName": "Study Lamp",
        "productDesc": "Lights and Lamps",
        "orderStatus": "CREATED"
    }

    {
        "orderNumber": 1004,
        "quantity": 5,
        "productName": "Study Lamp",
        "productDesc": "Lights and Lamps",
        "orderStatus": "CREATED"
    }

### Code

* The producer code is available at https://github.com/ijags/publishPartition
* The consumer code is available at https://github.com/ijags/consumePartition

### Additional References

* Visit https://docs.spring.io/spring-cloud-stream/reference/index.html: for more information.

### Recent Guides and Recipes

{{< latest-pages-section />}}

### All Pages

{{< children-sorted />}}
